#!/usr/bin/env bash
# Removes venv directories ONLY in projects containing a uv.lock file
# Prints each venv size and total reclaimed space at the end.

set -euo pipefail

ROOT="${1:-.}"

echo "üîç Searching for venvs to remove under: $ROOT"
echo

total_bytes=0

# Find all uv.lock files (process substitution keeps the loop in the current shell)
while read -r lockfile; do
    project_dir="$(dirname "$lockfile")"
    venv_path="$project_dir/.venv"

    if [ -d "$venv_path" ]; then
        # Get size in bytes (-b is GNU only, -k works everywhere)
        if du -sb /dev/null &>/dev/null; then
            size_bytes=$(du -sb "$venv_path" | awk '{print $1}')
        else
            size_bytes=$(( $(du -sk "$venv_path" | awk '{print $1}') * 1024 ))
        fi
        size_mb=$((size_bytes / 1024 / 1024))

        echo "üìÅ Found: $venv_path"
        echo "   Size: ${size_mb} MB"

        total_bytes=$((total_bytes + size_bytes))
        rm -rf "$venv_path"

        echo "   ‚úÖ Removed."
        echo
    fi
done < <(find "$ROOT" -type f -name "uv.lock")

# Print total reclaimed
total_mb=$((total_bytes / 1024 / 1024))

echo "üíæ Total space reclaimed: ${total_mb} MB"

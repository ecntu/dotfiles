#!/usr/bin/env bash

# Rsync but ignore .git and respect .gitignore.
rsyncg() {
  rsync -av --exclude='.git/' --filter=':- .gitignore' "$@"
}



# Rented SSH

RSSH_DIR="$HOME/.ssh/rented"
RSSH_CONFIG="$RSSH_DIR/config"
RSSH_KNOWN="$RSSH_DIR/known_hosts"

function rssh() {
	# Connect to a rented SSH server with a nice alias and custom config.
	# Usage: rssh ubuntu@94.101.98.227 [alias] [port] [identity_file]
	local userhost="$1"
	local alias="${2:-$(echo "$userhost" | awk -F'[@.]' '{print $1"-"$3"-"$4"-"$5"-"$6}')}"
	local port="${3:-22}"
	local ident="${4:-$HOME/.ssh/id_ed25519}"

	local user="${userhost%@*}"
	local host="${userhost##*@}"

	mkdir -p "$RSSH_DIR"
	touch "$RSSH_CONFIG"

	if ! grep -qE "^Host[[:space:]]+$alias$" "$RSSH_CONFIG"; then
	{
		printf "\nHost %s\n" "$alias"
		printf "  HostName %s\n" "$host"
		printf "  User %s\n" "$user"
		printf "  Port %s\n" "$port"
		printf "  IdentityFile %s\n" "$ident"
		printf "  IdentitiesOnly yes\n"
		printf "  UserKnownHostsFile %s\n" "$RSSH_KNOWN"
		printf "  ForwardAgent yes\n"
	} >> "$RSSH_CONFIG"
	echo "Added host '$alias' to $RSSH_CONFIG"
	fi

	ssh "$alias"
}

function clean-rssh() {
	local removed=0

	if [ -f "$RSSH_CONFIG" ]; then
	echo "Removing $RSSH_CONFIG"
	rm -f "$RSSH_CONFIG"
	removed=1
	fi

	if [ -f "$RSSH_KNOWN" ]; then
	echo "Removing $RSSH_KNOWN"
	rm -f "$RSSH_KNOWN"
	removed=1
	fi

	if [ "$removed" -eq 1 ]; then
	echo "Rented SSH config wiped clean."
	else
	echo "Nothing to clean."
  fi
}